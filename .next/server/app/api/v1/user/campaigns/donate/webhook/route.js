"use strict";(()=>{var e={};e.id=9111,e.ids=[9111],e.modules={38013:e=>{e.exports=require("mongodb")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},94885:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>x,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>f,staticGenerationAsyncStorage:()=>v});var a={};n.r(a),n.d(a,{POST:()=>m});var s=n(49303),o=n(88716),r=n(60670),i=n(87070),p=n(84770),u=n.n(p),d=n(75748),c=n(38013);async function m(e){let t=await e.text();if(e.headers.get("monnify-signature")!==u().createHmac("sha512",process.env.MONNIFY_SECRET_KEY).update(t).digest("hex"))return i.NextResponse.json({message:"Invalid signature"},{status:401});let n=JSON.parse(t);if("SUCCESSFUL_TRANSACTION"!==n.eventType)return i.NextResponse.json({message:"Ignored"});let{paymentReference:a,amountPaid:s}=n.eventData,o=(await d.Z).db("connect_africa"),r=o.collection("donations"),p=o.collection("campaigns"),m=await r.findOne({reference:a});if(!m)return i.NextResponse.json({message:"Donation not found"});if("success"===m.status)return i.NextResponse.json({message:"Already processed"});await r.updateOne({reference:a},{$set:{status:"success",paidAt:new Date}});let l=await p.findOne({_id:new c.ObjectId(m.campaignId)});if(!l)return i.NextResponse.json({message:"Campaign not found"});let g=l.donatedAmount+s,v=g>=l.amount?"completed":"inprogress";return await p.updateOne({_id:l._id},{$set:{donatedAmount:g,status:v,updatedAt:new Date},$inc:{volunteers:1}}),i.NextResponse.json({success:!0})}let l=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/v1/user/campaigns/donate/webhook/route",pathname:"/api/v1/user/campaigns/donate/webhook",filename:"route",bundlePath:"app/api/v1/user/campaigns/donate/webhook/route"},resolvedPagePath:"C:\\Users\\HP\\OneDrive\\Desktop\\project2\\connect africa\\src\\app\\api\\v1\\user\\campaigns\\donate\\webhook\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:v,serverHooks:f}=l,x="/api/v1/user/campaigns/donate/webhook/route";function w(){return(0,r.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:v})}},75748:(e,t,n)=>{n.d(t,{Z:()=>o});var a=n(38013);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define MONGODB_URI in .env");let o=new a.MongoClient(s).connect()}};var t=require("../../../../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),a=t.X(0,[9276,5972],()=>n(94885));module.exports=a})();